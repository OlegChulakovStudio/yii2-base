# Заготовки e-mail сообщений

Для отправки сообщения пользователю на электронную почту, обычно используется громоздкий
синтаксис сборки сообщения. Не редко сообщение отправляется из разных мест и часть
подготовки сообщения для отправки дублируется по несколько раз. В компонентах имеется
базовый класс почтового сообщения, который упростит использование отправки сообщения
до вызова пары методов.

## Использование

Класс имплементирует обращение к `Yii::$app->mailer` через конструктор и для упрощения
создания сообщения используется DI контейнер.

### Настройка контейнера

Загрузчик `\app\bootstrap\CommonBootstrap`
```
class CommonBootstrap implements BootstrapInterface
{
    /**
     * @param Application $app
     */
    public function bootstrap($app)
    {
        \Yii::$container->setSingleton('yii\mail\MailerInterface', function() use ($app) {
            return $app->mailer;
        });
    }
}
```

Конфигурация загрузчика `@app/config/main.php`
```
'bootstrap' => [
    \app\bootstrap\CommonBootstrap::class
],
```

### Создание сообщения

Базовый класс сообщения `\chulakov\base\mail\BaseMessage` реализует получение
почтового компонента и базовую настройку и передачу в почтовое сообщение необходимых
параметров и настроек. Поэтому минимальный объект подготовки сообщения выглядит так:

```
class Message extends BaseMessage
{
    protected $html = '@app/messages/html/message';
    protected $text = '@app/messages/text/message';
    protected $subject = 'Тема сообщения';

    public function send($email, $params = [])
    {
        return $this->compose($email, $params)->send();
    }
}
```

### Отправка сообщения

После подготовки объекта сообщения синтаксис отправки сообщения превращается в
короткий вызов на создание и отправку:

```
Message::create()->send('user@mail.ru');
```

### Расширенная конфигурация

Чтобы при сокращении обращения не ограничивать возможности по конфигурации сообщения,
реализовано множестов точек конфигурации, используя которые можно настроить как сам
объект сообщения, так и передать в сообщение требуемых параметров.

**Конфигурация объекта**

Для настроики объекта, можно передать массив конфигурации в метод `create`:
```
Message::create([
    'param' => 'value',
])->send(...)
```

**Параметры сообщения**

Почтовое уведомление часто содержит динамические части сообщения, ему необходимо
передать дополнительные параметры при подготовки к отправки:

```
Message::create()->send('user@mail.ru', [
    'url' => Url::to(['/site/action']),
    'model' => $model,
]);
```

**Конфигурация сообщения**

Поскольку синтаксис значительно упрощен, конфигурацией сообщения (исключая `subject` и `to`)
необходимо заниматься в методе `send()` или передав рассширенный массив в параметры
отправки сообщения, используя ключевое слово `properties`:

```
Message::create()->send('user@mail.ru', [
    'properties' => [
        'cc' => 'copy@mail.ru',
        'bcc' => 'bcc@mail.ru',
    ],
    'model' => $model,
]);
```

Массив `properties` не будет передан дальше для рендеринга сообщения.

**Постоянные параметры сообщения**

Бывают случаи, когда динамические параметры не меняются или конфигурируются отдельно.
Для этих случаев имеется специальный метод добавления постоянных сконфигурированных параметров:

```
protected function getExtendedParams()
{
    return [];
}
```

### Вложение файлов

Вложить файл можно один из следующих вариантов:

**Реализовать параметр вложения в объекте**

Чтобы вложить файл(ы) через параметры объекта, необходимо добавить поле в объект самого
сообщения, например `attachments`, который будет заполнен при создании нового объекта
сообщения и обработано в рамках подготовки сообщения в методе `send()`:

```php
public function send($email, $params = [])
{
    $message = $this->compose($email, $params);

    foreach ($this->attachments as $attachment) {
        $message->attach($attachment);
    }

    return $message->send();
}
```

**Воспользоваться альтернативным способом отправки**

Проигнорировать метод отправки или реализовать в нем отправку без вложения.
После чего использовать альтернативный вариант подготовки и отправки сообщения:

```php
Message::create()->compose($email, $params)->attach($filePath)->send();
```

**Нарушить интерфейс**

Добавить в список параметров метода `send()` третий **НЕОБЯЗАТЕЛЬНЫЙ** параметр с вложениями:

```php
public function send($email, $params = [], $attachments = []) {...}
```

Или реализовать проверку наличия в параметрах сообщения вложений:

```php
public function send($email, $params = [])
{
    $message = $this->compose($email, $params);
    $attachement = ArrayHelper::remove($params, 'attachments');
    foreach ($attachments as $attachment) {
        $message->attach($attachment);
    }
    return $message->send();
}
```
